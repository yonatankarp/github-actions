---
name: Dependabot auto-merge
on:
  workflow_call:
    inputs:
      auto-update-tag:
        type: boolean
        description: Indicates weather or not to run the inputs {{ tagging-script-path }} to update the tag of repository after successful merge
        default: false
        required: false
      tagging-script-path:
        type: string
        description: the path to the script to execute in order to tag the repository
        required: false
        default: ./bin/replace-tags.sh
    secrets:
      DEPENDABOT_MERGE_TOKEN:
        description: "token which belongs to a user that can approve and merge pr's"
        required: true

permissions:
  contents: write
  pull-requests: write

# The latest build tags the produced image with `latest` (or `pr-N` for PRs) tag. Concurrent builds can potentially cause
# inconsistency, e.g., when an older build finishes after the latest build. Currently, such inconsistency is still
# possible when an older build is replayed.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    env:
      TAG_VERSION: "v1"
    steps:

      - name: Dependabot Checkout
        if: ${{ inputs.auto-update-tag  == true && github.event_name == 'pull_request_target' }}
        uses: actions/checkout@v4
        with:
          # Dependabot can only checkout at the HEAD of the PR branch
          ref: ${{ github.event.pull_request.head.sha }}
          submodules: 'recursive'
          token: ${{ secrets.GITHUB_TOKEN }}

      # If the PR is created by Dependabot, run additional steps
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
	  
      - name: Approval for Dependabot PR
        if: ${{ steps.metadata.outputs.update-type == 'version-update:semver-minor' ||
          steps.metadata.outputs.update-type == 'version-update:semver-patch' }}
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.DEPENDABOT_MERGE_TOKEN }}

      - name: Wait for Status Checks
        run: gh pr checks -i 20 --watch --required "${PR_URL}"
        env:
          PR_URL:  ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.DEPENDABOT_MERGE_TOKEN }}

      - name: Enable auto-merge for Dependabot PRs
        if: ${{ steps.metadata.outputs.update-type == 'version-update:semver-minor' ||
          steps.metadata.outputs.update-type == 'version-update:semver-patch' }}
        run: gh pr merge --admin --rebase "$PR_URL"
        id: auto-merge
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.DEPENDABOT_MERGE_TOKEN }}

      - name: Move tag to current commit
        if: ${{ inputs.auto-update-tag == 'true' && 
              (steps.metadata.outputs.update-type == 'version-update:semver-minor' ||
               steps.metadata.outputs.update-type == 'version-update:semver-patch') }}
        run: sh ${{ inputs.tagging-script-path }} ${{ env.TAG_VERSION }}
