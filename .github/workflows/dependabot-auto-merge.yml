name: dependabot auto merge

on:
  workflow_call:
    inputs:
      auto-update-tag:
        type: boolean
        description: Run tagging script after successful merge
        default: false
        required: false
      tagging-script-path:
        type: string
        description: Path to a script that tags the repo
        default: ./bin/replace-tags.sh
        required: false
    secrets:
      GITHUB_PAT:
        required: false
        description: Optional PAT if you need a human approval identity

jobs:
  dependabot_auto_merge:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      TAG_VERSION: v1
      # Prefer PAT if provided; else use the workflow token
      GH_TOKEN: ${{ secrets.GITHUB_PAT || github.token }}
      PR_URL: ${{ github.event.pull_request.html_url }}

    steps:
      # Only needed if you actually run a script from the repo (tagging)
      - name: Checkout (for tagging script)
        if: inputs.auto-update-tag
        uses: actions/checkout@v4
        with:
          # For Dependabot PRs in the same repo this is safe
          ref: ${{ github.event.pull_request.head.sha }}
          submodules: recursive
          token: ${{ env.GH_TOKEN }}

      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ env.GH_TOKEN }}

      - name: Approve a Dependabot PR (minor/patch)
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-minor' ||
          steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: gh pr review --approve "$PR_URL"

      - name: Enable auto-merge (minor/patch)
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-minor' ||
          steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: gh pr merge --auto --rebase "$PR_URL"

      - name: Move tag to current commit
        if: |
          inputs.auto-update-tag &&
          (steps.metadata.outputs.update-type == 'version-update:semver-minor' ||
           steps.metadata.outputs.update-type == 'version-update:semver-patch')
        run: sh "${{ inputs.tagging-script-path }}" "${{ env.TAG_VERSION }}"
